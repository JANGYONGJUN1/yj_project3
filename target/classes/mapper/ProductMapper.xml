<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.board.mapper.ProductMapper">

	<sql id="productOrderBy"> order by product_idx ASC </sql>
	<sql id="selectProduct">
		select 
			product_idx  as productIdx,
	        product_name as productName,
	        content      as content,
	        img1         as img1,
	        img2 		 as img2,
	        img3 		 as img3,
	        views        as views,
	        price		 as price,
	        cnt			 as cnt,
	        detail_img as detailImg
		from product
	</sql>
	<select id ="getProductAll" parameterType ="java.lang.Integer" resultType="com.board.vo.ProductVO">
		<include refid="selectProduct"/>
		<where>
			<if test="category != null">
				product_category = #{category}
			</if>
		</where>
		<include refid="productOrderBy"></include>
	</select>
	
	
	<select id ="getSearchList" parameterType ="java.util.Map" resultType="com.board.vo.ProductVO">
		<include refid="selectProduct"/>
		<where>
			<if test="category != null">
				product_category = #{category}
			</if>
			<if test="keyword != null and keyword !='' ">
				product_name like '%' || #{keyword} || '%'
			</if>
		</where>
		<include refid="productOrderBy"></include>
	</select>
	
	<select id="getProductByIdx" parameterType="Integer" resultType="com.board.vo.ProductVO">
		<include refid="selectProduct"/>
		where product_idx = #{productIdx}
	</select>
	
	<select id="getReview" parameterType="map" resultType="com.board.vo.ReviewsVO">
		select pr.user_id, pr.score, pr.regdate, pr.product_idx, pr.review_idx, pr.content
		from product_reviews pr
		left outer join kakao_table kt on kt.kakao_number = pr.kakao_number
		inner join users u on u.memberid = pr.user_id
		inner join product p on p.product_idx = pr.product_idx
		where pr.product_idx = #{productIdx}
		
		<choose>
			<when test="sortType == 'score'">
				order by score DESC, regdate DESC
			</when>
			<when test="sortType == 'low_score'">
				order by score ASC, regdate DESC
			</when>
			<otherwise>
				order by regdate DESC, review_idx DESC
			</otherwise>
		</choose>
	</select>
	
	<select id="getCountReview" parameterType="int" resultType="int">
		select count(*)
		from product_reviews
		where product_idx = ${productIdx}
	</select>
	
	<select id="getCartList" parameterType="int" resultType ="com.board.vo.ProductCartListVO">
		select p.img1, p.product_name, p.product_idx, pcl.quantity, p.price, pcl.cart_idx
		from product_cart_list pcl
		inner join product p on p.product_idx = pcl.product_idx
		inner join users u on u.user_idx = pcl.user_idx
		where pcl.user_idx = #{userIdx}
	</select>
		 
	<insert id="saveCart" parameterType="java.util.Map">
		insert into product_cart_list (
			cart_idx,
			user_idx,
			product_idx,
			quantity,
			regdate
		)
		values(
			PRODUCT_CARTIDX.nextval, 
			#{userIdx}, #{productIdx}, 
			#{quantity}, 
			sysdate
		)
	</insert>
	
	<delete id="deleteCartItem" parameterType="int">
		delete
		from product_cart_list
		where cart_idx = #{cartIdx}
		and user_idx = #{userIdx}
	</delete>
	
	<delete id="deleteSelectedCartItem">
		delete
		from product_cart_list
		where user_idx = #{userIdx}
		and cart_idx in 
		<foreach collection="cartIdxList" item="cartIdx" open="(" separator="," close=")">
	        #{cartIdx}
	    </foreach>
	</delete>
	
	
	
	
</mapper>